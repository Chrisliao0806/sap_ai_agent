# ğŸ›’ SAP è«‹è³¼ç³»çµ± AI Agent

## ç³»çµ±æ¦‚è¿°

é€™æ˜¯ä¸€å€‹åŸºæ–¼ AI çš„æ™ºèƒ½è«‹è³¼ç³»çµ±ï¼Œèƒ½å¤ ï¼š

1. **æ™ºèƒ½éœ€æ±‚åˆ†æ** - åˆ†æä½¿ç”¨è€…çš„è«‹è³¼éœ€æ±‚
2. **æ­·å²æ•¸æ“šåˆ†æ** - èª¿ç”¨æ¡è³¼æ­·å² API ç²å–ç›¸é—œæ•¸æ“š
3. **ç”¢å“æ¨è–¦** - åŸºæ–¼æ­·å²æ•¸æ“šå’Œéœ€æ±‚æ¨è–¦æœ€ä½³ç”¢å“è¦æ ¼
4. **è‡ªå‹•åŒ–è«‹è³¼** - å‰µå»ºä¸¦æäº¤è«‹è³¼å–®åˆ° SAP ç³»çµ±

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

```mermaid
graph TB
    A[ä½¿ç”¨è€…è«‹è³¼éœ€æ±‚] --> B[éœ€æ±‚åˆ†æ Agent]
    B --> C[æ¡è³¼æ­·å² API]
    C --> D[LLM ç”¢å“æ¨è–¦]
    D --> E[ä½¿ç”¨è€…ç¢ºèª]
    E --> F[å‰µå»ºè«‹è³¼å–®]
    F --> G[æäº¤åˆ° SAP API]
    G --> H[è«‹è³¼å–®è™Ÿ]
```

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. ç’°å¢ƒæº–å‚™

```bash
# å…‹éš†æˆ–ä¸‹è¼‰å°ˆæ¡ˆ
cd sap_ai_agent

# å®‰è£ä¾è³´
pip install -r requirements.txt

# è¨­å®šç’°å¢ƒè®Šæ•¸
cp .env.example .env
# ç·¨è¼¯ .env æª”æ¡ˆï¼Œå¡«å…¥æ‚¨çš„ OpenAI API Key
```

### 2. è¨­å®šç’°å¢ƒè®Šæ•¸

åœ¨ `.env` æª”æ¡ˆä¸­è¨­å®šï¼š

```bash
OPENAI_API_KEY=your-openai-api-key-here
OPENAI_BASE_URL=https://api.openai.com/v1
SAP_API_BASE_URL=http://localhost:7777
```

### 3. å•Ÿå‹•ç³»çµ±

**æ­¥é©Ÿ 1ï¼šå•Ÿå‹• SAP API æœå‹™å™¨**
```bash
python app.py
```

**æ­¥é©Ÿ 2ï¼šæ¸¬è©¦è«‹è³¼ç³»çµ±**
```bash
# ç°¡å–®æ¼”ç¤º
python demo_purchase.py

# å®Œæ•´æ¸¬è©¦
python test_purchase_system.py

# ç›´æ¥ä½¿ç”¨æ¨¡çµ„
python purchase_agent.py
```

## ğŸ“‹ ä½¿ç”¨ç¯„ä¾‹

### åŸºæœ¬ä½¿ç”¨

```python
from purchase_agent import PurchaseAgent, PurchaseAgentConfig
import os

# å»ºç«‹é…ç½®
config = PurchaseAgentConfig(
    api_base_url="http://localhost:7777",
    model="gpt-4o-mini",
    openai_api_key=os.getenv("OPENAI_API_KEY")
)

# å»ºç«‹ Agent
agent = PurchaseAgent(config)

# è™•ç†è«‹è³¼éœ€æ±‚
request = "æˆ‘éœ€è¦ç‚ºè»Ÿé«”é–‹ç™¼éƒ¨é–€æ¡è³¼ MacBook Proï¼Œè¨˜æ†¶é«”16GBä»¥ä¸Šï¼Œéœ€è¦3å°"
result, tokens = agent.process_purchase_request(request)

print(f"è™•ç†çµæœ: {result}")
print(f"Token ä½¿ç”¨é‡: {tokens}")
```

### ä¸²æµæ¨¡å¼

```python
import queue
import threading

# è¨­å®šä¸²æµä½‡åˆ—
stream_queue = queue.Queue()
agent.attach_stream_queue(stream_queue)

# è™•ç†ä¸²æµè¼¸å‡º
def handle_stream():
    while True:
        token = stream_queue.get()
        if token == "[[END]]":
            break
        print(token, end="", flush=True)

# å•Ÿå‹•ä¸²æµè™•ç†
stream_thread = threading.Thread(target=handle_stream)
stream_thread.start()

# è™•ç†è«‹è³¼
result, tokens = agent.process_purchase_request(request)
stream_thread.join()
```

## ğŸ¯ åŠŸèƒ½ç‰¹è‰²

### 1. æ™ºèƒ½éœ€æ±‚åˆ†æ
- è‡ªå‹•è§£æè«‹è³¼éœ€æ±‚ä¸­çš„ç”¢å“é¡å‹ã€æ•¸é‡ã€é ç®—ç­‰é—œéµè³‡è¨Š
- è­˜åˆ¥æ¥­å‹™éƒ¨é–€å’Œä½¿ç”¨ç”¨é€”
- æå–æ™‚é–“éœ€æ±‚å’Œå„ªå…ˆç´š

### 2. æ­·å²æ•¸æ“šæ™ºèƒ½åˆ†æ
- è‡ªå‹•èª¿ç”¨æ¡è³¼æ­·å² API ç²å–ç›¸é—œæ•¸æ“š
- åˆ†æä¾›æ‡‰å•†è¡¨ç¾å’Œåƒ¹æ ¼è¶¨å‹¢
- è­˜åˆ¥æœ€ä½³æ¡è³¼æ™‚æ©Ÿå’Œè¦æ ¼

### 3. ç”¢å“æ¨è–¦å¼•æ“
- åŸºæ–¼æ­·å²æ¡è³¼æ•¸æ“šæ¨è–¦æœ€é©åˆçš„ç”¢å“
- æä¾›å¤šå€‹æ›¿ä»£æ–¹æ¡ˆ
- è€ƒæ…®æˆæœ¬æ•ˆç›Šå’Œä¾›æ‡‰å•†å¯é æ€§

### 4. è‡ªå‹•åŒ–æµç¨‹
- è‡ªå‹•å‰µå»ºç¬¦åˆè¦ç¯„çš„è«‹è³¼å–®
- ä¸€éµæäº¤åˆ° SAP ç³»çµ±
- å¯¦æ™‚è¿½è¹¤è«‹è³¼ç‹€æ…‹

## ğŸ“Š æ¸¬è©¦æ¡ˆä¾‹

ç³»çµ±å…§å»ºå¤šç¨®æ¸¬è©¦æ¡ˆä¾‹ï¼š

1. **è»Ÿé«”é–‹ç™¼éƒ¨é–€ç­†é›»éœ€æ±‚**
   ```
   æˆ‘éœ€è¦ç‚ºè»Ÿé«”é–‹ç™¼éƒ¨é–€æ¡è³¼æ–°çš„ç­†è¨˜å‹é›»è…¦ï¼Œè¦æ±‚MacBook Proï¼Œè¨˜æ†¶é«”16GBä»¥ä¸Šï¼Œéœ€è¦3å°ï¼Œé ç®—æ¯å°7.5è¬å…ƒã€‚
   ```

2. **è¨­è¨ˆéƒ¨é–€é¡¯ç¤ºå™¨éœ€æ±‚**
   ```
   è¨­è¨ˆéƒ¨é–€éœ€è¦4Ké¡¯ç¤ºå™¨ï¼Œ27å‹ï¼Œéœ€è¦5å°ï¼Œé ç®—æ¯å°2è¬å…ƒä»¥å…§ã€‚
   ```

3. **è¡ŒéŠ·éƒ¨é–€å¹³æ¿éœ€æ±‚**
   ```
   è¡ŒéŠ·éƒ¨é–€éœ€è¦iPad Proç”¨æ–¼å®¢æˆ¶å±•ç¤ºï¼Œ12.9å‹ï¼Œéœ€è¦2å°ã€‚
   ```

## ğŸ”§ ç³»çµ±é…ç½®

### PurchaseAgentConfig åƒæ•¸èªªæ˜

| åƒæ•¸ | é¡å‹ | é è¨­å€¼ | èªªæ˜ |
|------|------|--------|------|
| `api_base_url` | str | "http://localhost:7777" | SAP API åŸºç¤ URL |
| `model` | str | "gpt-4o-mini" | ä½¿ç”¨çš„ LLM æ¨¡å‹ |
| `max_tokens` | int | 1024 | æœ€å¤§ Token æ•¸é‡ |
| `temperature` | float | 0.3 | æ¨¡å‹å‰µé€ æ€§åƒæ•¸ |
| `openai_api_key` | str | "" | OpenAI API Key |
| `openai_base_url` | str | "https://api.openai.com/v1" | OpenAI API åŸºç¤ URL |

## ğŸ“ API ç«¯é»

ç³»çµ±ä½¿ç”¨ä»¥ä¸‹ SAP API ç«¯é»ï¼š

- `GET /api/purchase-history` - ç²å–æ¡è³¼æ­·å²
- `POST /api/purchase-request` - å‰µå»ºè«‹è³¼å–®
- `GET /api/purchase-request/{id}` - æŸ¥è©¢è«‹è³¼ç‹€æ…‹

## ğŸ” å·¥ä½œæµç¨‹è©³è§£

1. **éœ€æ±‚åˆ†æ** (`analyze_request`)
   - è§£æä½¿ç”¨è€…è¼¸å…¥çš„è«‹è³¼éœ€æ±‚
   - æå–é—œéµè³‡è¨Šï¼ˆç”¢å“é¡å‹ã€æ•¸é‡ã€é ç®—ç­‰ï¼‰

2. **ç²å–æ­·å²æ•¸æ“š** (`fetch_purchase_history`)
   - èª¿ç”¨æ¡è³¼æ­·å² API
   - ç²å–ç›¸é—œçš„æ­·å²æ¡è³¼è¨˜éŒ„

3. **ç”¢å“æ¨è–¦** (`recommend_product`)
   - åˆ†ææ­·å²æ•¸æ“šå’Œä½¿ç”¨è€…éœ€æ±‚
   - ç”Ÿæˆç”¢å“æ¨è–¦å’Œæ›¿ä»£æ–¹æ¡ˆ

4. **å‰µå»ºè«‹è³¼å–®** (`create_purchase_order`)
   - æ ¹æ“šæ¨è–¦çµæœå‰µå»ºæ­£å¼è«‹è³¼å–®
   - åŒ…å«æ‰€æœ‰å¿…è¦æ¬„ä½å’Œè³‡è¨Š

5. **æäº¤è«‹è³¼** (`submit_purchase_order`)
   - å°‡è«‹è³¼å–®æäº¤åˆ° SAP ç³»çµ±
   - è¿”å›è«‹è³¼å–®è™Ÿå’Œç‹€æ…‹

6. **ç”Ÿæˆå›æ‡‰** (`generate_final_response`)
   - ç”Ÿæˆæœ€çµ‚çš„è™•ç†çµæœ
   - æä¾›è«‹è³¼å–®è™Ÿå’Œè¿½è¹¤è³‡è¨Š

## ğŸ› ï¸ æ¸¬è©¦å’Œé™¤éŒ¯

### é‹è¡Œæ¸¬è©¦

```bash
# åŸºæœ¬åŠŸèƒ½æ¸¬è©¦
python test_purchase_system.py

# é¸æ“‡æ¸¬è©¦æ¨¡å¼ï¼š
# 1. åŸºæœ¬åŠŸèƒ½æ¸¬è©¦
# 2. ä¸²æµå›æ‡‰æ¸¬è©¦
# 3. äº’å‹•æ¨¡å¼
# 4. éŒ¯èª¤è™•ç†æ¸¬è©¦
# 5. å®Œæ•´æ¸¬è©¦
```

### å¸¸è¦‹å•é¡Œ

1. **API é€£æ¥å¤±æ•—**
   - ç¢ºä¿ SAP API æœå‹™å™¨æ­£åœ¨é‹è¡Œï¼š`python app.py`
   - æª¢æŸ¥ API URL è¨­å®šæ˜¯å¦æ­£ç¢º

2. **OpenAI API éŒ¯èª¤**
   - ç¢ºèª API Key è¨­å®šæ­£ç¢º
   - æª¢æŸ¥ç¶²è·¯é€£ç·šå’Œ API é…é¡

3. **è«‹è³¼å–®å‰µå»ºå¤±æ•—**
   - æª¢æŸ¥è«‹è³¼æ•¸æ“šæ ¼å¼æ˜¯å¦æ­£ç¢º
   - ç¢ºèªæ‰€æœ‰å¿…è¦æ¬„ä½éƒ½å·²å¡«å…¥

## ğŸ” å®‰å…¨è€ƒé‡

- API Key æ‡‰è©²é€éç’°å¢ƒè®Šæ•¸è¨­å®šï¼Œä¸è¦ç›´æ¥å¯«åœ¨ä»£ç¢¼ä¸­
- ç”Ÿç”¢ç’°å¢ƒæ‡‰è©²ä½¿ç”¨ HTTPS é€£æ¥
- è«‹è³¼å–®æ‡‰è©²åŒ…å«é©ç•¶çš„é©—è­‰å’Œæˆæ¬Šæ©Ÿåˆ¶

## ğŸ“ˆ æ•ˆèƒ½å„ªåŒ–

- ä½¿ç”¨ä¸²æµæ¨¡å¼æä¾›å³æ™‚å›é¥‹
- å¿«å–å¸¸ç”¨çš„æ¡è³¼æ­·å²æ•¸æ“š
- å„ªåŒ– LLM æç¤ºä»¥æ¸›å°‘ Token æ¶ˆè€—

## ğŸ¤ è²¢ç»æŒ‡å—

æ­¡è¿æäº¤ Issue å’Œ Pull Request ä¾†æ”¹å–„ç³»çµ±åŠŸèƒ½ï¼

## ğŸ“„ æˆæ¬Š

MIT License - è©³è¦‹ LICENSE æ–‡ä»¶